<!DOCTYPE html>
<html>
<head>
    <title>Test Media Size Display</title>
    <script>
        // Copy the formatFileSize function
        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let unitIndex = 0;
            while (bytes >= 1024 && unitIndex < units.length - 1) {
                bytes /= 1024;
                unitIndex++;
            }
            return `${bytes.toFixed(2)} ${units[unitIndex]}`;
        }

        // Copy the calculateBase64Size function
        function calculateBase64Size(base64String) {
            // Remove any whitespace that might be in the base64 string
            const cleanBase64 = base64String.replace(/\s/g, '');
            // Each base64 character represents 6 bits, and padding is accounted for
            const padding = (cleanBase64.match(/=/g) || []).length;
            const sizeInBytes = Math.floor((cleanBase64.length * 3) / 4) - padding;
            return sizeInBytes;
        }

        // Copy the get_media_size function
        function get_media_size(text) {
            if (Array.isArray(text) || !text) {
                return null;
            }
            
            // Check for base64-encoded image in markdown format: [![alt](data:image/...))](...)
            const imageMarkdownMatch = text.match(/!\[.*?\]\(data:image\/[^;]+;base64,([A-Za-z0-9+/=]+)\)/);
            if (imageMarkdownMatch && imageMarkdownMatch[1]) {
                return calculateBase64Size(imageMarkdownMatch[1]);
            }
            
            // Check for base64-encoded media in video/audio tags: <video controls src="data:..."></video>
            const mediaTagMatch = text.match(/<(?:video|audio)[^>]*src="data:[^;]+;base64,([A-Za-z0-9+/=]+)"/);
            if (mediaTagMatch && mediaTagMatch[1]) {
                return calculateBase64Size(mediaTagMatch[1]);
            }
            
            return null;
        }

        function runTests() {
            const results = document.getElementById('results');
            
            // Test 1: Small base64 image
            const smallImage = '[![test](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==)]()';
            const size1 = get_media_size(smallImage);
            results.innerHTML += `<p>Test 1 - Small image: ${size1 !== null ? formatFileSize(size1) : 'Failed to detect'}</p>`;
            
            // Test 2: Video tag
            const videoTag = '<video controls src="data:video/mp4;base64,AAAAGGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAs1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1MiByMjg1NCBlOWE1OTAzIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNyAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTYgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAACWWIhAAz//727L4FNf2f0JcRLMXaSnA="></video>';
            const size2 = get_media_size(videoTag);
            results.innerHTML += `<p>Test 2 - Video tag: ${size2 !== null ? formatFileSize(size2) : 'Failed to detect'}</p>`;
            
            // Test 3: Regular text (should return null)
            const regularText = 'This is just regular text without any media.';
            const size3 = get_media_size(regularText);
            results.innerHTML += `<p>Test 3 - Regular text: ${size3 === null ? 'Correctly returned null' : 'Incorrectly detected media'}</p>`;
            
            // Test 4: Text with image markdown but no base64
            const urlImage = '[![test](https://example.com/image.png)]()';
            const size4 = get_media_size(urlImage);
            results.innerHTML += `<p>Test 4 - URL image: ${size4 === null ? 'Correctly returned null' : 'Incorrectly detected media'}</p>`;
        }
    </script>
</head>
<body onload="runTests()">
    <h1>Media Size Detection Tests</h1>
    <div id="results"></div>
</body>
</html>
